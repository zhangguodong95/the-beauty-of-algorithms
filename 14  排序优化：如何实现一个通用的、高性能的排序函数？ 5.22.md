## 14 | 排序优化：如何实现一个通用的、高性能的排序函数？ 5.22

几乎所有的编程语言都会提供排序函数，比如 C 语言中 qsort()，C++ STL 中的 sort()、stable_sort()，还有 Java 语言中的 Collections.sort()。在平时的开发中，我们也都是直接使用这些现成的函数来实现业务逻辑中的排序功能。那你知道这些排序函数是如何实现的吗？底层都利用了哪种排序算法呢？

### 如何选择合适的排序算法？

### 如何优化快速排序？

当快速排序的分区点选的不够好的时候，每次分区完两边很不均衡，甚至出现只有一边有数据的极端情况，那么快速排序的时间复杂度就会从nlog(n)退化到o(n2)。显然我们是不希望看到的，那么解决这个问题的关键就是选择合适的分区点，是分区两边均衡。下面介绍两种常用的，简单的分区点选择方法。

**1.三数取中法**

从区间的首、尾、中间分别取出一个数，然后对比大小，去这3个数的中间值作为分区点。如果数组很大也可以五数取中，十数取中思想是一样的。

**2.随机法**

每次从要排序的区间中，随机选择一个元素作为分区点。

递归要警惕堆栈溢出。为了避免快速排序里，递归过深而堆栈过小，导致堆栈溢出，我们有两种解决办法：第一种是限制递归深度。一旦递归过深，超过了我们事先设定的阈值，就停止递归。第二种是通过在堆上模拟实现一个函数调用栈，手动模拟递归压栈、出栈的过程，这样就没有了系统栈大小的限制。

### 举例分析排序函数

c语言中的qsort举例：qsort会优先使用归并排序，因为归并排序的时间复杂度最稳定，最好最坏都是olog(n)。但是当数据量很大的时候就不能使用归并排序，因为它有空间复杂度o(n),这个时候转化成使用快速排序。它的分区方法就是三数取中法。

实际上，qsort() 并不仅仅用到了归并排序和快速排序，它还用到了插入排序。在快速排序的过程中，当要排序的区间中，元素的个数小于等于 4 时，qsort() 就退化为插入排序，不再继续用递归来做快速排序，因为我们前面也讲过，**在小规模数据面前，O(n2) 时间复杂度的算法并不一定比 O(nlogn) 的算法执行时间长**。

### 内容小结

今天我带你分析了一下如何来实现一个工业级的通用的、高效的排序函数，内容比较偏实战，而且贯穿了一些前面几节的内容，你要多看几遍。我们大部分排序函数都是采用 O(nlogn) 排序算法来实现，但是为了尽可能地提高性能，会做很多优化。

我还着重讲了快速排序的一些优化策略，比如合理选择分区点、避免递归太深等等。最后，我还带你分析了一个 C 语言中 qsort() 的底层实现原理，希望你对此能有一个更加直观的感受。